<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor CSV Web</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #controls {
      margin-bottom: 20px;
    }
    #tableContainer {
      margin-top: 20px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    input[type="text"], select {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-right: 10px;
      padding: 8px 12px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 5px;
    }
    .invalid-row {
      background-color: #fdd;
    }
  </style>
</head>
<body>

  <h1>Editor de CSV Web 游</h1>

  <div id="controls">
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="addRow()">Agregar Pasajeros</button>
    <button onclick="removeSelectedRows()">Eliminar filas seleccionadas</button>
    <button onclick="sortTableAndRender()">Ordenar por Apellido</button>
    <button onclick="openModal()" id="saveBtn">Guardar Como</button>
  </div>

  <div id="tableContainer"></div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h3>Nombre del archivo</h3>
      <input type="text" id="fileNameInputModal" placeholder="Nombre sin .csv">
      <br><br>
      <button onclick="confirmDownload()">Aceptar</button>
      <button onclick="closeModal()">Cancelar</button>
    </div>
  </div>

  <script>
    let tableData = [];

    const defaultHeader = [
      "apellido",
      "nombre",
      "tipo_documento",
      "descripcion_documento",
      "numero_documento",
      "sexo",
      "menor",
      "nacionalidad",
      "tripulante",
      "ocupa_butaca",
      "observaciones"
    ];

    const validValues = {
      tipo_documento: ["DNI", "Pasaporte", "OTROS"],
      sexo: ["F", "M"],
      menor: ["0", "1"],
      nacionalidad: ["Afganist치n", "Albania", "Alemania", "Andorra", "Angola", "Anguilla", "Ant치rtida", "Antigua y Barbuda", "Antillas Holandesas", "Arabia Saud칤", "Argelia", "Argentina", "Armenia", "Aruba", "ARY Macedonia", "Australia", "Austria", "Azerbaiy치n", "Bahamas", "Bahr칠in", "Bangladesh", "Barbados", "B칠lgica", "Belice", "Benin", "Bermudas", "Bhut치n", "Bielorrusia", "Bolivia", "Bosnia y Herzegovina", "Botsuana", "Brasil", "Brun칠i", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Camboya", "Camer칰n", "Canad치", "Chad", "Chile", "China", "Chipre", "Ciudad del Vaticano", "Colombia", "Comoras", "Congo", "Corea del Norte", "Corea del Sur", "Costa de Marfil", "Costa Rica", "Croacia", "Cuba", "Dinamarca", "Dominica", "Ecuador", "Egipto", "El Salvador", "Emiratos 츼rabes Unidos", "Eritrea", "Eslovaquia", "Eslovenia", "Espa침a", "Estados Unidos", "Estonia", "Etiop칤a", "Filipinas", "Finlandia", "Fiyi", "Francia", "Gab칩n", "Gambia", "Georgia", "Ghana", "Gibraltar", "Granada", "Grecia", "Groenlandia", "Guadalupe", "Guam", "Guatemala", "Guayana Francesa", "Guinea", "Guinea Ecuatorial", "Guinea-Bissau", "Guyana", "Hait칤", "Honduras", "Hong Kong", "Hungr칤a", "India", "Indonesia", "Ir치n", "Iraq", "Irlanda", "Isla Bouvet", "Isla de Navidad", "Isla Norfolk", "Islandia", "Islas Caim치n", "Islas Cocos", "Islas Cook", "Islas Feroe", "Islas Georgias del Sur y Sandwich del Sur", "Islas Gland", "Islas Heard y McDonald", "Islas Malvinas", "Islas Marianas del Norte", "Islas Marshall", "Islas Pitcairn", "Islas Salom칩n", "Islas Turcas y Caicos", "Islas ultramarinas de Estados Unidos", "Islas V칤rgenes Brit치nicas", "Islas V칤rgenes de los Estados Unidos", "Israel", "Italia", "Jamaica", "Jap칩n", "Jordania", "Kazajst치n", "Kenia", "Kirguist치n", "Kiribati", "Kuwait", "Laos", "Lesotho", "Letonia", "L칤bano", "Liberia", "Libia", "Liechtenstein", "Lituania", "Luxemburgo", "Macao", "Madagascar", "Malasia", "Malawi", "Maldivas", "Mal칤", "Malta", "Marruecos", "Martinica", "Mauricio", "Mauritania", "Mayotte", "M칠xico", "Micronesia", "Moldavia", "M칩naco", "Mongolia", "Montserrat", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Nicaragua", "N칤ger", "Nigeria", "Niue", "Noruega", "Nueva Caledonia", "Nueva Zelanda", "Om치n", "Pa칤ses Bajos", "Pakist치n", "Palau", "Palestina", "Panam치", "Pap칰a Nueva Guinea", "Paraguay", "Per칰", "Polinesia Francesa", "Polonia", "Portugal", "Puerto Rico", "Qatar", "Reino Unido", "Rep칰blica Centroafricana", "Rep칰blica Checa", "Rep칰blica Democr치tica del Congo", "Rep칰blica Dominicana", "Reuni칩n", "Ruanda", "Rumania", "Rusia", "Sahara Occidental", "Samoa", "Samoa Americana", "San Crist칩bal y Nevis", "San Marino", "San Pedro y Miquel칩n", "San Vicente y las Granadinas", "Santa Helena", "Santa Luc칤a", "Santo Tom칠 y Pr칤ncipe", "Senegal", "Serbia y Montenegro", "Seychelles", "Sierra Leona", "Singapur", "Siria", "Somalia", "Sri Lanka", "Suazilandia", "Sud치frica", "Sud치n", "Suecia", "Suiza", "Surinam", "Svalbard y Jan Mayen", "Tailandia", "Taiw치n", "Tanzania", "Tayikist치n", "Territorio Brit치nico del Oc칠ano 칈ndico", "Territorios Australes Franceses", "Timor Oriental", "Togo", "Tokelau", "Tonga", "Trinidad y Tobago", "T칰nez", "Turkmenist치n", "Turqu칤a", "Tuvalu", "Ucrania", "Uganda", "Uruguay", "Uzbekist치n", "Vanuatu", "Venezuela", "Vietnam", "Wallis y Futuna", "Yemen", "Yibuti", "Zambia", "Zimbabue"],
      tripulante: ["0", "1"],
      ocupa_butaca: ["0", "1"]
    };

    const defaults = {
      tipo_documento: "DNI",
      sexo: "F",
      menor: "0",
      nacionalidad: "Argentina",
      tripulante: "0",
      ocupa_butaca: "1",
      observaciones: ""
    };

    window.onload = function () {
      if (tableData.length === 0) {
        tableData = [defaultHeader];
        renderTable();
      }
    };

    document.getElementById('csvFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (event) {
        const text = event.target.result;
        tableData = parseCSV(text);
        renderTable();
      };
      reader.readAsText(file);
    });

    function parseCSV(text) {
  const rows = text.trim().split('\n').map(row => row.split(';'));
  let header = rows[0];
  const body = rows.slice(1);

  const requiredColumns = [
    { name: 'ocupa_butaca', defaultValue: '1' },
    { name: 'observaciones', defaultValue: '' }
  ];

  requiredColumns.forEach(col => {
    if (!header.includes(col.name)) {
      header.push(col.name);
      body.forEach(row => row.push(col.defaultValue));
    }
  });

  return [header, ...body];
}
    function isRowValid(row) {
      return getValidationError(row) === "";
    }

    function getValidationError(row) {
      const tipoDoc = row[2]?.trim().toUpperCase();
      const numeroDoc = row[4]?.trim();
      const apellido = row[0]?.trim();
      const nombre = row[1]?.trim();

      if (!apellido || apellido.length > 100) {
        return "Apellido requerido (m치ximo 100 caracteres)";
      }

      if (!nombre || nombre.length > 100) {
        return "Nombre requerido (m치ximo 100 caracteres)";
      }

      if (tipoDoc === "DNI") {
        if (!/^\d{7,8}$/.test(numeroDoc)) {
          return "DNI debe contener solo n칰meros (7 a 8 d칤gitos)";
        }
      } else if (tipoDoc === "PASAPORTE" || tipoDoc === "OTROS") {
        if (numeroDoc.length < 5 || numeroDoc.length > 100) {
          return "N칰mero de documento debe tener entre 5 y 100 caracteres";
        }
      } else {
        return "Tipo de documento inv치lido";
      }

      return "";
    }

    function renderTable() {
      const container = document.getElementById('tableContainer');
      const table = document.createElement('table');
      container.innerHTML = '';

      if (tableData.length === 0) return;

      const header = tableData[0];
      const body = tableData.slice(1);

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');

      headRow.innerHTML = `<th>Sel</th><th>#</th>` +
        header.map((title, i) => i === 3 ? '' : `<th>${title.trim()}</th>`).join('');

      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      const seenDocuments = new Set();
      let invalidIndexes = new Set();

      body.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.innerHTML += `<td><input type="checkbox" class="rowCheckbox" data-index="${rowIndex + 1}"></td>`;
        tr.innerHTML += `<td>${rowIndex + 1}</td>`;

        row.forEach((cell, colIndex) => {
          if (colIndex === 3) return;

          const td = document.createElement('td');
          const columnName = header[colIndex];

          if (validValues[columnName]) {
            const select = document.createElement('select');
            const options = validValues[columnName];

            options.forEach(value => {
              const option = document.createElement('option');
              option.value = value;
              option.textContent = ["tripulante", "ocupa_butaca", "menor","tripulante"].includes(columnName) && (value === "0" || value === "1")
                ? (value === "1" ? "SI" : "NO")
                : value;
              if (cell.trim().toUpperCase() === value.toUpperCase()) option.selected = true;
              select.appendChild(option);
            });

            select.addEventListener('change', e => {
              tableData[rowIndex + 1][colIndex] = e.target.value;
              renderTable();
            });

            td.appendChild(select);
          } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = cell.trim();

            input.addEventListener('input', e => {
            tableData[rowIndex + 1][colIndex] = e.target.value.trim();
             });

             input.addEventListener('blur', e => {
               tableData[rowIndex + 1][colIndex] = e.target.value.trim();
              renderTable(); // Ejecuta validaci칩n al salir del campo
             });


            td.appendChild(input);
          }

          tr.appendChild(td);
        });

        const docNum = row[4].trim();
        const isDuplicate = seenDocuments.has(docNum);
        const errorMessage = getValidationError(row);

        if (!isDuplicate) seenDocuments.add(docNum);

        if (isDuplicate || errorMessage) {
          tr.classList.add('invalid-row');
          tr.title = isDuplicate ? "N칰mero de documento duplicado" : errorMessage;
          invalidIndexes.add(rowIndex + 1);
        }

        tbody.appendChild(tr);
      });

      document.getElementById('saveBtn').disabled = invalidIndexes.size > 0;
      table.appendChild(tbody);
      container.appendChild(table);
      updateTableData(header, body);
    }

    function updateTableData(header, body) {
      tableData = [header, ...body];
    }

    function addRow() {
      if (tableData.length === 0) {
        tableData = [defaultHeader];
      }
      const newRow = defaultHeader.map(col => defaults[col] || '');
      tableData.push(newRow);
      renderTable();
    }

    function removeSelectedRows() {
      const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
      const indexesToRemove = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
      if (indexesToRemove.length === 0) {
        alert('No hay filas seleccionadas para eliminar.');
        return;
      }
      indexesToRemove.sort((a, b) => b - a);
      indexesToRemove.forEach(index => {
        tableData.splice(index, 1);
      });
      renderTable();
    }

    function sortTableAndRender() {
      if (tableData.length <= 1) return;
      const header = tableData[0];
      const body = tableData.slice(1);
      body.sort((a, b) => (a[0]?.toLowerCase() || '').localeCompare(b[0]?.toLowerCase() || ''));
      tableData = [header, ...body];
      renderTable();
    }

    function openModal() {
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function confirmDownload() {
      const fileNameInput = document.getElementById('fileNameInputModal').value.trim();
      const fileName = fileNameInput ? fileNameInput + '.csv' : 'datos_editados.csv';
      const csvContent = tableData.map(row => row.join(';')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      closeModal();
    }
  </script>

</body>
</html>
