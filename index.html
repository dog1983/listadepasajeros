<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor CSV Web</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #controls {
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    input[type="text"], select {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-right: 10px;
      padding: 8px 12px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 5px;
    }
    .invalid-row {
      background-color: #fdd;
    }
    .hidden-col {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Editor de CSV Web</h1>

  <div id="controls">
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="addRow()">Agregar fila</button>
    <button onclick="removeSelectedRows()">Eliminar filas seleccionadas</button>
    <button onclick="sortTable()">Ordenar por Apellido</button>
    <button onclick="openModal()">Guardar Como</button>
  </div>

  <div id="tableContainer"></div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h3>Nombre del archivo</h3>
      <input type="text" id="fileNameInputModal" placeholder="Nombre sin .csv">
      <br><br>
      <button onclick="confirmDownload()">Aceptar</button>
      <button onclick="closeModal()">Cancelar</button>
    </div>
  </div>

  <script>
    const defaultHeader = ["apellido", "nombre", "tipo_documento", "descripcion_documento", "numero_documento", "sexo", "menor", "nacionalidad", "tripulante", "ocupa_butaca"];
    const validValues = { tipo_documento: ["DNI", "Pasaporte", "OTROS"], sexo: ["F", "M"], menor: ["0", "1"], tripulante: ["0", "1"], ocupa_butaca: ["0", "1"] };
    const defaults = { tipo_documento: "DNI", sexo: "F", menor: "0", tripulante: "0", ocupa_butaca: "1" };

    let csvData = [];
    let invalidRows = new Set();

    document.getElementById('csvFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (event) {
        let rows = event.target.result.trim().split('\n').map(r => r.split(';'));
        const lowerHeaders = rows[0].map(h => h.trim().toLowerCase());
        if (!lowerHeaders.includes("ocupa_butaca")) {
          rows[0].push("ocupa_butaca");
          for (let i = 1; i < rows.length; i++) rows[i].push(defaults.ocupa_butaca);
        }
        csvData = rows;
        renderTable();
      };
      reader.readAsText(file);
    });

    function renderTable() {
      const container = document.getElementById('tableContainer');
      container.innerHTML = '';
      const table = document.createElement('table');
      const header = csvData[0];
      const body = csvData.slice(1);
      const numeroDocs = new Set();
      invalidRows.clear();

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      headRow.innerHTML = `<th>Seleccionar</th><th>#</th>` + header.map(h => `<th${h === 'descripcion_documento' ? ' class="hidden-col"' : ''}>${h}</th>`).join('');
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      body.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.innerHTML += `<td><input type='checkbox' class='rowCheckbox' data-index='${rowIndex + 1}'></td>`;
        tr.innerHTML += `<td>${rowIndex + 1}</td>`;

        if (numeroDocs.has(row[4])) invalidRows.add(rowIndex + 1);
        numeroDocs.add(row[4]);

        row.forEach((cell, colIndex) => {
          const colName = header[colIndex];
          const td = document.createElement('td');
          if (colName === 'descripcion_documento') td.classList.add('hidden-col');

          if (["menor", "tripulante", "ocupa_butaca"].includes(colName)) {
            const sel = document.createElement('select');
            ["NO", "SI"].forEach((txt, i) => {
              const opt = new Option(txt, i);
              if (cell === String(i)) opt.selected = true;
              sel.add(opt);
            });
            sel.onchange = e => csvData[rowIndex + 1][colIndex] = e.target.value;
            td.appendChild(sel);
          } else if (validValues[colName]) {
            const sel = document.createElement('select');
            validValues[colName].forEach(optVal => {
              const opt = new Option(optVal, optVal);
              if (cell === optVal) opt.selected = true;
              sel.add(opt);
            });
            sel.onchange = e => csvData[rowIndex + 1][colIndex] = e.target.value;
            td.appendChild(sel);
          } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = cell;
            input.onblur = () => {
              const value = input.value.trim();
              csvData[rowIndex + 1][colIndex] = value;
              if (colName === 'numero_documento') {
                const count = csvData.map(r => r[4]).filter(v => v === value).length;
                const tipo = csvData[rowIndex + 1][2];
                const dniOk = tipo === "DNI" && /^\d{7,8}$/.test(value);
                const otrosOk = ["Pasaporte", "OTROS"].includes(tipo) && value.length >= 5 && value.length <= 100;
                if (count > 1 || (tipo === "DNI" && !dniOk) || (["Pasaporte", "OTROS"].includes(tipo) && !otrosOk)) {
                  invalidRows.add(rowIndex + 1);
                  tr.classList.add('invalid-row');
                } else {
                  invalidRows.delete(rowIndex + 1);
                  tr.classList.remove('invalid-row');
                }
              }
            };
            td.appendChild(input);
          }
          tr.appendChild(td);
        });
        if (invalidRows.has(rowIndex + 1)) tr.classList.add('invalid-row');
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function addRow() {
      const newRow = defaultHeader.map(col => defaults[col] || '');
      csvData.push(newRow);
      renderTable();
    }

    function removeSelectedRows() {
      const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
      const indices = [...checkboxes].map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
      for (let i of indices) csvData.splice(i, 1);
      renderTable();
    }

    function sortTable() {
      csvData = [csvData[0], ...csvData.slice(1).sort((a, b) => a[0].localeCompare(b[0]))];
      renderTable();
    }

    function openModal() {
      if (invalidRows.size > 0) {
        alert("Corrige los errores antes de guardar. Hay campos duplicados o invÃ¡lidos.");
        return;
      }
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function confirmDownload() {
      const fileNameInput = document.getElementById('fileNameInputModal').value.trim();
      const fileName = fileNameInput ? fileNameInput + '.csv' : 'datos_editados.csv';
      const csvContent = csvData.map(row => row.join(';')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      closeModal();
    }
  </script>
</body>
</html>
