<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor CSV Web</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #controls {
      margin-bottom: 20px;
    }
    #tabs {
      margin-bottom: 10px;
    }
    .tab {
      display: inline-block;
      padding: 10px 15px;
      background-color: #eee;
      cursor: pointer;
      border: 1px solid #ccc;
      border-bottom: none;
    }
    .tab.active {
      background-color: white;
      font-weight: bold;
    }
    .table-pane {
      display: none;
    }
    .table-pane.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    input[type="text"], select {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-right: 10px;
      padding: 8px 12px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 5px;
    }
    .invalid-row {
      background-color: #fdd;
    }
    .hidden-col {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Editor de CSV Web con m√∫ltiples archivos üìÅ</h1>

  <div id="controls">
    <input type="file" id="csvFile" accept=".csv" multiple>
  </div>

  <div id="tabs"></div>
  <div id="panes"></div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h3>Nombre del archivo</h3>
      <input type="text" id="fileNameInputModal" placeholder="Nombre sin .csv">
      <br><br>
      <button onclick="confirmDownload()">Aceptar</button>
      <button onclick="closeModal()">Cancelar</button>
    </div>
  </div>

  <script>
    const defaultHeader = ["apellido", "nombre", "tipo_documento", "descripcion_documento", "numero_documento", "sexo", "menor", "nacionalidad", "tripulante", "ocupa_butaca"];
    const validValues = { tipo_documento: ["DNI", "Pasaporte", "OTROS"], sexo: ["F", "M"], menor: ["0", "1"], tripulante: ["0", "1"], ocupa_butaca: ["0", "1"] };
    const defaults = { tipo_documento: "DNI", sexo: "F", menor: "0", tripulante: "0", ocupa_butaca: "1" };

    let filesData = []; // [{ name: string, data: string[][], invalidRows: Set<number> }]
    let activeIndex = 0;

    document.getElementById('csvFile').addEventListener('change', function (e) {
      const files = e.target.files;
      for (let file of files) {
        const reader = new FileReader();
        reader.onload = function (event) {
          let rows = event.target.result.trim().split('\n').map(r => r.split(';'));
          if (!rows[0].includes("ocupa_butaca")) {
            rows[0].push("ocupa_butaca");
            for (let i = 1; i < rows.length; i++) rows[i].push(defaults.ocupa_butaca);
          }
          filesData.push({ name: file.name, data: rows, invalidRows: new Set() });
          activeIndex = filesData.length - 1;
          renderTabs();
          renderTables();
        };
        reader.readAsText(file);
      }
    });

    function renderTabs() {
      const tabs = document.getElementById('tabs');
      tabs.innerHTML = '';
      filesData.forEach((file, i) => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (i === activeIndex ? ' active' : '');
        tab.textContent = file.name;
        tab.onclick = () => { activeIndex = i; renderTabs(); renderTables(); };
        tabs.appendChild(tab);
      });
    }

    function renderTables() {
      const panes = document.getElementById('panes');
      panes.innerHTML = '';
      filesData.forEach((file, i) => {
        const pane = document.createElement('div');
        pane.className = 'table-pane' + (i === activeIndex ? ' active' : '');
        const controls = `
          <div>
            <button onclick="addRow(${i})">Agregar fila</button>
            <button onclick="removeSelectedRows(${i})">Eliminar filas seleccionadas</button>
            <button onclick="sortTable(${i})">Ordenar por Apellido</button>
            <button onclick="openModal(${i})">Guardar Como</button>
          </div><br>`;
        const table = document.createElement('div');
        table.id = 'tableContainer_' + i;
        pane.innerHTML = controls;
        pane.appendChild(table);
        panes.appendChild(pane);
        renderTable(i);
      });
    }

    function renderTable(index) {
      const file = filesData[index];
      const container = document.getElementById('tableContainer_' + index);
      container.innerHTML = '';

      const table = document.createElement('table');
      const header = file.data[0];
      const body = file.data.slice(1);
      const numeroDocs = new Set();
      file.invalidRows.clear();

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      headRow.innerHTML = `<th>Seleccionar</th><th>#</th>` + header.map((h, i) => `<th${h === 'descripcion_documento' ? ' class="hidden-col"' : ''}>${h}</th>`).join('');
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      body.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.innerHTML += `<td><input type='checkbox' class='rowCheckbox' data-index='${rowIndex + 1}'></td>`;
        tr.innerHTML += `<td>${rowIndex + 1}</td>`;

        if (numeroDocs.has(row[4])) file.invalidRows.add(rowIndex + 1);
        numeroDocs.add(row[4]);

        row.forEach((cell, colIndex) => {
          const colName = header[colIndex];
          const td = document.createElement('td');
          if (colName === 'descripcion_documento') td.classList.add('hidden-col');
          if (["menor", "tripulante", "ocupa_butaca"].includes(colName)) {
            const sel = document.createElement('select');
            ["NO", "SI"].forEach((txt, i) => {
              const opt = new Option(txt, i);
              if (cell === String(i)) opt.selected = true;
              sel.add(opt);
            });
            sel.onchange = e => file.data[rowIndex + 1][colIndex] = e.target.value;
            td.appendChild(sel);
          } else if (validValues[colName]) {
            const sel = document.createElement('select');
            validValues[colName].forEach(optVal => {
              const opt = new Option(optVal, optVal);
              if (cell === optVal) opt.selected = true;
              sel.add(opt);
            });
            sel.onchange = e => file.data[rowIndex + 1][colIndex] = e.target.value;
            td.appendChild(sel);
          } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = cell;
            input.onblur = () => {
              const value = input.value.trim();
              file.data[rowIndex + 1][colIndex] = value;
              if (colName === 'numero_documento') {
                const count = file.data.map(r => r[4]).filter(v => v === value).length;
                if (count > 1 || (file.data[rowIndex + 1][2] === "DNI" && !/^\d{7,8}$/.test(value)) || (["Pasaporte", "OTROS"].includes(file.data[rowIndex + 1][2]) && (value.length < 5 || value.length > 100))) {
                  file.invalidRows.add(rowIndex + 1);
                  tr.classList.add('invalid-row');
                } else {
                  file.invalidRows.delete(rowIndex + 1);
                  tr.classList.remove('invalid-row');
                }
              }
            };
            td.appendChild(input);
          }
          tr.appendChild(td);
        });
        if (file.invalidRows.has(rowIndex + 1)) tr.classList.add('invalid-row');
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    function addRow(index) {
      const file = filesData[index];
      const newRow = defaultHeader.map(col => defaults[col] || '');
      file.data.push(newRow);
      renderTable(index);
    }

    function removeSelectedRows(index) {
      const checkboxes = document.querySelectorAll(`#tableContainer_${index} .rowCheckbox:checked`);
      const indices = [...checkboxes].map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
      for (let i of indices) filesData[index].data.splice(i, 1);
      renderTable(index);
    }

    function sortTable(index) {
      const file = filesData[index];
      file.data = [file.data[0], ...file.data.slice(1).sort((a, b) => a[0].localeCompare(b[0]))];
      renderTable(index);
    }

    function openModal(index) {
      if (filesData[index].invalidRows.size > 0) {
        alert("Corrige los errores antes de guardar. Hay campos duplicados o inv√°lidos.");
        return;
      }
      document.getElementById('modal').style.display = 'flex';
      document.getElementById('modal').dataset.index = index;
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function confirmDownload() {
      const fileNameInput = document.getElementById('fileNameInputModal').value.trim();
      const fileName = fileNameInput ? fileNameInput + '.csv' : 'datos_editados.csv';
      const index = parseInt(document.getElementById('modal').dataset.index);
      const csvContent = filesData[index].data.map(row => row.join(';')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      closeModal();
    }
  </script>
</body>
</html>
